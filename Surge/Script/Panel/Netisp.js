// 2023-10-04 23:53:17
let pro={updata:{"说明":"可在持久化数据中更改是否在面板中显示这样可以直接使用远程链接，不用放在本地即可修改，输错了会自动恢复默认重新运行后重写JSON里的参数即可","cnTimeout 为入口超时时间":"usTimeout 为落地超时时间","icons 为图标":"icolor 为颜色","hideIP 为":"是否隐藏IP","开为":true,"关为":false},version:20230922.1,"以下为":"配置参数",icons:"globe.asia.australia",icolor:"#6699FF",GPT:false,hideIP:true,cnTimeout:1e3,usTimeout:3e3,nw:true},data,updata=true,re=false,ke=false;(async()=>{try{try{let e=$persistentStore.read("KeyNetisp"),t=$environment;data=e?JSON.parse(e):pro;try{!(t["surge-build"]<2867)&&(ke=true);if(data.version<pro.version){data.cnTimeout=pro.cnTimeout;data.usTimeout=pro.usTimeout;data.version=pro.version;console.log("升级: V"+pro.version);$persistentStore.write(JSON.stringify(data,"",2),"KeyNetisp")}}catch(e){updata=false}if(data.nw||!updata||data.version!==pro.version||typeof data.hideIP!=="boolean"||typeof data.GPT!=="boolean"||typeof data.icons!=="string"||typeof data.icolor!=="string"||typeof data.cnTimeout!=="number"||typeof data.usTimeout!=="number"||typeof data.updata!=="object"){console.log("无数据或数据错误或更新,恢复默认");delete pro.nw;re=true;data=pro}}catch(e){console.log("无数据或数据错误或更新,恢复默认");data=pro;re=true}re&&$persistentStore.write(JSON.stringify(pro,"",2),"KeyNetisp");let e=data.GPT,t=data.icons,o=data.icolor,i=data.hideIP,n=data.cnTimeout,s=data.usTimeout;let a="",r="",l="节点信息查询",c="代理链",u="",p="",d="",f="";const g=await tKey("http://ip-api.com/json/?lang=zh-CN",s);if(g.status==="success"&&ke){console.log("ipapi"+JSON.stringify(g,null,2));let{country:e,countryCode:t,regionName:o,query:n,city:s,org:r,isp:l,as:c,tk:p}=g;a=n;i&&(n=HIP(n));e===s&&(s="");let d=getflag(t)+e+" "+s;u=" \t"+d+"\n落地IP: \t"+n+": "+p+"ms"+"\n落地ISP: \t"+l+"\n落地ASN: \t"+c+""}else{console.log("ild"+JSON.stringify(g));u=""}if(e){const e=await tKey("http://chat.openai.com/cdn-cgi/trace",s);const t=["CN","TW","HK","IR","KP","RU","VE","BY"];if(typeof e!=="string"){let{loc:o,tk:i,warp:n,ip:s}=e,a=t.indexOf(o),r="";if(a==-1){r="GPT: "+o+" ✓"}else{r="GPT: "+o+" ×"}if(n="plus"){n="Plus"}l=r+"       ➟     Priv: "+n+"   "+i+"ms"}else{l="ChatGPT "+e}}const m=await httpAPI();let y,P="";const h=m.requests.slice(0,6);let w=h.filter((e=>/ip-api\.com/.test(e.URL)));if(w.length>0&&ke){const e=w[0];f=": "+e.policyName;if(/\(Proxy\)/.test(e.remoteAddress)){y=e.remoteAddress.replace(" (Proxy)","");c=""}else{y="Noip";P="代理链地区:"}}else{y="Noip"}if($environment["surge-build"]<2867){throw new Error("")}let k=false,N="spe",T=false,I="edtest";isv6=false,cn=true;if(y==="Noip"){k=true}else if(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(y)){T=true}else if(/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(y)){isv6=true}if(y==a){cn=false;P="直连节点:"}else{if(P===""){P="落地地区:"}if(!k||T){const e=await tKey(`https://api-v3.${N}${I}.cn/ip?ip=${y}`,n);if(e.code===0&&e.data.country==="中国"){let{province:t,isp:o,city:n,countryCode:s}=e.data,a=e.tk;console.log("ik"+JSON.stringify(e,null,2));cn=true;i&&(y=HIP(y));p="入口国家: \t"+getflag(s)+t+" "+n+"\n入口IP: \t"+y+": "+a+"ms"+"\n入口ISP: \t"+o+c+"\n---------------------\n"}else{cn=false;console.log("ik"+JSON.stringify(e));p="入口IPA Failed\n"}}if((!k||isv6)&&!cn){const e=await tKey(`http://ip-api.com/json/${y}?lang=zh-CN`,s);if(e.status==="success"){console.log("iai"+JSON.stringify(e,null,2));let{countryCode:t,country:o,city:n,tk:s,isp:a}=e;i&&(y=HIP(y));let r=o+" "+n;p="入口国家: \t"+getflag(t)+r+"\n入口IP: \t"+y+": "+s+"ms"+"\n入口ISP: \t"+a+c+"\n---------------------\n"}else{console.log("iai"+JSON.stringify(e));p="入口IPB Failed\n"}}}$done({title:l+f,content:d+r+p+P+u,icon:t,"icon-color":o})}catch(e){console.log(e.message);$done({title:outgpt+nodeNames,content:local+outbli+outik+outld+zl,icon:icons,"icon-color":icolor})}})(),function e(t,o){if(t.length>o){return t.slice(0,o)}else if(t.length<o){return t.toString().padEnd(o," ")}else{return t}};function sK(e,t){return e.split(" ",t).join(" ").replace(/\.|\,|com|\u4e2d\u56fd/g,"")}function HIP(e){return e.replace(/(\w{1,4})(\.|\:)(\w{1,4})$/,((e,t,o,i)=>`${"∗".repeat(t.length)}.${"∗".repeat(i.length)}`))}async function httpAPI(e="/v1/requests/recent",t="GET",o=null){return new Promise(((i,n)=>{$httpAPI(t,e,o,(e=>{i(e)}))}))}function getflag(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t).replace(/🇹🇼/g,"🇨🇳")}async function tKey(e,t){let o=1,i=1;const s=new Promise(((s,a)=>{const r=async l=>{try{const o=await Promise.race([new Promise(((t,o)=>{let i=Date.now();$httpClient.get({url:e},((e,n,s)=>{if(e){o(e)}else{let e=Date.now()-i;let o=n.status;switch(o){case 200:let o=n.headers["Content-Type"];switch(true){case o.includes("application/json"):let i=JSON.parse(s);i.tk=e;t(i);break;case o.includes("text/html"):t("text/html");break;case o.includes("text/plain"):let n=s.split("\n");let a=n.reduce(((t,o)=>{let[i,n]=o.split("=");t[i]=n;t.tk=e;return t}),{});t(a);break;case o.includes("image/svg+xml"):t("image/svg+xml");break;default:t("未知");break}break;case 204:let i={tk:e};t(i);break;case 429:console.log("次数过多");t("次数过多");break;case 404:console.log("404");t("404");break;default:t("nokey");break}}}))})),new Promise(((e,o)=>{setTimeout((()=>o(new Error("timeout"))),t)}))]);if(o){s(o)}else{s("超时");a(new Error(n.message))}}catch(e){if(l<o){i++;r(l+1)}else{s("检测失败, 重试次数"+i);a(e)}}};r(0)}));return s}
