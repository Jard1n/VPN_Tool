console.log("\uD83C\uDF7F️ DualSubs: \uD83C\uDFB5 Spotify"),console.log("request.bundle.js"),console.log("Version: 1.9.12"),console.log("Date: 2025/10/25 12:40:56"),(()=>{"use strict";let e,t=(()=>{let e=Object.keys(globalThis);switch(!0){case e.includes("$task"):return"Quantumult X";case e.includes("$loon"):return"Loon";case e.includes("$rocket"):return"Shadowrocket";case"undefined"!=typeof module:return"Node.js";case e.includes("Egern"):return"Egern";case e.includes("$environment"):if($environment["surge-version"])return"Surge";if($environment["stash-version"])return"Stash";return;default:return}})();class a{static #e=new Map([]);static #t=[];static #a=new Map([]);static clear=()=>{};static count=(e="default")=>{switch(a.#e.has(e)){case!0:a.#e.set(e,a.#e.get(e)+1);break;case!1:a.#e.set(e,0)}a.log(`${e}: ${a.#e.get(e)}`)};static countReset=(e="default")=>{switch(a.#e.has(e)){case!0:a.#e.set(e,0),a.log(`${e}: ${a.#e.get(e)}`);break;case!1:a.warn(`Counter "${e}" doesn’t exist`)}};static debug=(...e)=>{a.#s<4||(e=e.map(e=>`🅱️ ${e}`),a.log(...e))};static error(...e){if(!(a.#s<1)){switch(t){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Quantumult X":default:e=e.map(e=>`❌ ${e}`);break;case"Node.js":e=e.map(e=>`❌ ${e.stack}`)}a.log(...e)}}static exception=(...e)=>a.error(...e);static group=e=>a.#t.unshift(e);static groupEnd=()=>a.#t.shift();static info(...e){a.#s<3||(e=e.map(e=>`ℹ️ ${e}`),a.log(...e))}static #s=3;static get logLevel(){switch(a.#s){case 0:return"OFF";case 1:return"ERROR";case 2:return"WARN";case 3:default:return"INFO";case 4:return"DEBUG";case 5:return"ALL"}}static set logLevel(e){switch(typeof e){case"string":e=e.toLowerCase();break;case"number":break;default:e="warn"}switch(e){case 0:case"off":a.#s=0;break;case 1:case"error":a.#s=1;break;case 2:case"warn":case"warning":default:a.#s=2;break;case 3:case"info":a.#s=3;break;case 4:case"debug":a.#s=4;break;case 5:case"all":a.#s=5}}static log=(...e)=>{0!==a.#s&&(e=e.map(e=>{switch(typeof e){case"object":e=JSON.stringify(e);break;case"bigint":case"number":case"boolean":case"string":e=e.toString()}return e}),a.#t.forEach(t=>{(e=e.map(e=>`  ${e}`)).unshift(`▼ ${t}:`)}),console.log((e=["",...e]).join("\n")))};static time=(e="default")=>a.#a.set(e,Date.now());static timeEnd=(e="default")=>a.#a.delete(e);static timeLog=(e="default")=>{let t=a.#a.get(e);t?a.log(`${e}: ${Date.now()-t}ms`):a.warn(`Timer "${e}" doesn’t exist`)};static warn(...e){a.#s<2||(e=e.map(e=>`⚠️ ${e}`),a.log(...e))}}class s{static escape(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,e=>t[e])}static get(e={},t="",a){Array.isArray(t)||(t=s.toPath(t));let r=t.reduce((e,t)=>Object(e)[t],e);return void 0===r?a:r}static omit(e={},t=[]){return Array.isArray(t)||(t=[t.toString()]),t.forEach(t=>s.unset(e,t)),e}static pick(e={},t=[]){return Array.isArray(t)||(t=[t.toString()]),Object.fromEntries(Object.entries(e).filter(([e,a])=>t.includes(e)))}static set(e,t,a){return Array.isArray(t)||(t=s.toPath(t)),t.slice(0,-1).reduce((e,a,s)=>Object(e[a])===e[a]?e[a]:e[a]=/^\d+$/.test(t[s+1])?[]:{},e)[t[t.length-1]]=a,e}static toPath(e){return e.replace(/\[(\d+)\]/g,".$1").split(".").filter(Boolean)}static unescape(e){let t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,e=>t[e])}static unset(e={},t=""){return Array.isArray(t)||(t=s.toPath(t)),t.reduce((e,a,s)=>s===t.length-1?(delete e[a],!0):Object(e)[a],e)}}let r={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",304:"Not Modified",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Content Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"};function o(e={}){switch(t){case"Surge":e.policy&&s.set(e,"headers.X-Surge-Policy",e.policy),a.log("\uD83D\uDEA9 执行结束!",`🕛 ${new Date().getTime()/1e3-$script.startTime} 秒`),$done(e);break;case"Loon":e.policy&&(e.node=e.policy),a.log("\uD83D\uDEA9 执行结束!",`🕛 ${(new Date-$script.startTime)/1e3} 秒`),$done(e);break;case"Stash":e.policy&&s.set(e,"headers.X-Stash-Selected-Proxy",encodeURI(e.policy)),a.log("\uD83D\uDEA9 执行结束!",`🕛 ${(new Date-$script.startTime)/1e3} 秒`),$done(e);break;case"Egern":case"Shadowrocket":a.log("\uD83D\uDEA9 执行结束!"),$done(e);break;case"Quantumult X":switch(e.policy&&s.set(e,"opts.policy",e.policy),typeof(e=s.pick(e,["status","url","headers","body","bodyBytes"])).status){case"number":e.status=`HTTP/1.1 ${e.status} ${r[e.status]}`;break;case"string":case"undefined":break;default:throw TypeError(`${Function.name}: 参数类型错误, status 必须为数字或字符串`)}e.body instanceof ArrayBuffer?(e.bodyBytes=e.body,e.body=void 0):ArrayBuffer.isView(e.body)?(e.bodyBytes=e.body.buffer.slice(e.body.byteOffset,e.body.byteLength+e.body.byteOffset),e.body=void 0):e.body&&(e.bodyBytes=void 0),a.log("\uD83D\uDEA9 执行结束!"),$done(e);break;default:a.log("\uD83D\uDEA9 执行结束!"),process.exit(1)}}async function i(e,a={}){switch(typeof e){case"object":e={...a,...e};break;case"string":e={...a,url:e};break;default:throw TypeError(`${Function.name}: 参数类型错误, resource 必须为对象或字符串`)}!e.method&&(e.method="GET",(e.body??e.bodyBytes)&&(e.method="POST")),delete e.headers?.Host,delete e.headers?.[":authority"],delete e.headers?.["Content-Length"],delete e.headers?.["content-length"];let o=e.method.toLocaleLowerCase();switch(!e.timeout&&(e.timeout=5),e.timeout&&(e.timeout=Number.parseInt(e.timeout,10),e.timeout>500&&(e.timeout=Math.round(e.timeout/1e3))),t){case"Loon":case"Surge":case"Stash":case"Egern":case"Shadowrocket":default:if(e.timeout&&"Loon"===t&&(e.timeout=1e3*e.timeout),e.policy)switch(t){case"Loon":e.node=e.policy;break;case"Stash":s.set(e,"headers.X-Stash-Selected-Proxy",encodeURI(e.policy));break;case"Shadowrocket":s.set(e,"headers.X-Surge-Proxy",e.policy)}switch("boolean"==typeof e.redirection&&(e["auto-redirect"]=e.redirection),e.bodyBytes&&!e.body&&(e.body=e.bodyBytes,e.bodyBytes=void 0),(e.headers?.Accept||e.headers?.accept)?.split(";")?.[0]){case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":case"application/vnd.apple.flatbuffer":case"application/grpc":case"application/grpc+proto":case"application/octet-stream":e["binary-mode"]=!0}return await new Promise((t,a)=>{$httpClient[o](e,(s,o,i)=>{s?a(s):(o.ok=/^2\d\d$/.test(o.status),o.statusCode=o.status,o.statusText=r[o.status],i&&(o.body=i,!0==e["binary-mode"]&&(o.bodyBytes=i)),t(o))})});case"Quantumult X":return e.timeout=1e3*e.timeout,e.policy&&s.set(e,"opts.policy",e.policy),"boolean"==typeof e["auto-redirect"]&&s.set(e,"opts.redirection",e["auto-redirect"]),e.body instanceof ArrayBuffer?(e.bodyBytes=e.body,e.body=void 0):ArrayBuffer.isView(e.body)?(e.bodyBytes=e.body.buffer.slice(e.body.byteOffset,e.body.byteLength+e.body.byteOffset),e.body=void 0):e.body&&(e.bodyBytes=void 0),Promise.race([await $task.fetch(e).then(e=>{switch(e.ok=/^2\d\d$/.test(e.statusCode),e.status=e.statusCode,e.statusText=r[e.status],(e.headers?.["Content-Type"]??e.headers?.["content-type"])?.split(";")?.[0]){case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":case"application/vnd.apple.flatbuffer":case"application/grpc":case"application/grpc+proto":case"application/octet-stream":e.body=e.bodyBytes}return e.bodyBytes=void 0,e},e=>Promise.reject(e.error)),new Promise((t,a)=>{setTimeout(()=>{a(Error(`${Function.name}: 请求超时, 请检查网络后重试`))},e.timeout)})]);case"Node.js":{let t=globalThis.fetch?globalThis.fetch:require("node-fetch"),a=(globalThis.fetchCookie?globalThis.fetchCookie:require("fetch-cookie").default)(t);e.timeout=1e3*e.timeout,e.redirect=e.redirection?"follow":"manual";let{url:s,...r}=e;return Promise.race([await a(s,r).then(async e=>{let t,a=await e.arrayBuffer();try{t=e.headers.raw()}catch{t=Array.from(e.headers.entries()).reduce((e,[t,a])=>(e[t]=e[t]?[...e[t],a]:[a],e),{})}return{ok:e.ok??/^2\d\d$/.test(e.status),status:e.status,statusCode:e.status,statusText:e.statusText,body:new TextDecoder("utf-8").decode(a),bodyBytes:a,headers:Object.fromEntries(Object.entries(t).map(([e,t])=>[e,"set-cookie"!==e.toLowerCase()?t.toString():t]))}}).catch(e=>Promise.reject(e.message)),new Promise((t,a)=>{setTimeout(()=>{a(Error(`${Function.name}: 请求超时, 请检查网络后重试`))},e.timeout)})])}}}class c{static data=null;static dataFile="box.dat";static #r=/^@(?<key>[^.]+)(?:\.(?<path>.*))?$/;static getItem(e,a=null){let r=a;if(!0===e.startsWith("@")){let{key:t,path:a}=e.match(c.#r)?.groups;e=t;let o=c.getItem(e,{});"object"!=typeof o&&(o={}),r=s.get(o,a);try{r=JSON.parse(r)}catch(e){}}else{switch(t){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":r=$persistentStore.read(e);break;case"Quantumult X":r=$prefs.valueForKey(e);break;case"Node.js":c.data=c.#o(c.dataFile),r=c.data?.[e];break;default:r=c.data?.[e]||null}try{r=JSON.parse(r)}catch(e){}}return r??a}static setItem(e=new String,a=new String){let r=!1;if(a="object"==typeof a?JSON.stringify(a):String(a),!0===e.startsWith("@")){let{key:t,path:o}=e.match(c.#r)?.groups;e=t;let i=c.getItem(e,{});"object"!=typeof i&&(i={}),s.set(i,o,a),r=c.setItem(e,i)}else switch(t){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":r=$persistentStore.write(a,e);break;case"Quantumult X":r=$prefs.setValueForKey(a,e);break;case"Node.js":c.data=c.#o(c.dataFile),c.data[e]=a,c.#i(c.dataFile),r=!0;break;default:r=c.data?.[e]||null}return r}static removeItem(e){let a=!1;if(!0===e.startsWith("@")){let{key:t,path:r}=e.match(c.#r)?.groups;e=t;let o=c.getItem(e);"object"!=typeof o&&(o={}),keyValue=s.unset(o,r),a=c.setItem(e,o)}else switch(t){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:a=!1;break;case"Quantumult X":a=$prefs.removeValueForKey(e)}return a}static clear(){let e=!1;switch(t){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:e=!1;break;case"Quantumult X":e=$prefs.removeAllValues()}return e}static #o=e=>{if("Node.js"!==t)return{};{this.fs=this.fs?this.fs:require("node:fs"),this.path=this.path?this.path:require("node:path");let t=this.path.resolve(e),a=this.path.resolve(process.cwd(),e),s=this.fs.existsSync(t),r=!s&&this.fs.existsSync(a);if(!s&&!r)return{};try{return JSON.parse(this.fs.readFileSync(s?t:a))}catch(e){return{}}}};static #i=(e=this.dataFile)=>{if("Node.js"===t){this.fs=this.fs?this.fs:require("node:fs"),this.path=this.path?this.path:require("node:path");let t=this.path.resolve(e),a=this.path.resolve(process.cwd(),e),s=this.fs.existsSync(t),r=!s&&this.fs.existsSync(a),o=JSON.stringify(this.data);s?this.fs.writeFileSync(t,o):r?this.fs.writeFileSync(a,o):this.fs.writeFileSync(t,o)}}}function n(e){return/^\d+$/.test(e)&&(e=Number.parseInt(e,10)),e}let l={Spotify:{Settings:{CountryCode:"US",Types:["Translate","External"],Languages:["AUTO","ZH"]}},Default:{Settings:{Type:"Translate",Types:["Official","Translate"],Languages:["EN","ZH"],CacheSize:50,LogLevel:"WARN"},Configs:{breakLine:{"text/xml":"&#x000A;","application/xml":"&#x000A;","text/vtt":"\n","application/vtt":"\n","text/json":"\n","application/json":"\n"}}}},u=new URL($request.url);a.info(`url: ${u.toJSON()}`);let d=u.pathname.split("/").filter(Boolean);a.info(`PATHs: ${d}`);let p=($request.headers?.["Content-Type"]??$request.headers?.["content-type"])?.split(";")?.[0];a.info(`FORMAT: ${p}`),(async()=>{let{Settings:e,Caches:r,Configs:o}=function(e,t,r){a.log("☑️ Set Environment Variables");let{Settings:o,Caches:i,Configs:l}=function(e,t,a){t=[t].flat(1/0);let r={Settings:a?.Default?.Settings||{},Configs:a?.Default?.Configs||{},Caches:{}};switch(t.forEach(e=>{r.Settings={...r.Settings,...a?.[e]?.Settings},r.Configs={...r.Configs,...a?.[e]?.Configs}}),typeof $argument){case"string":$argument=Object.fromEntries($argument.split("&").map(e=>e.split("=",2).map(e=>e.replace(/\"/g,""))));case"object":{let e={};Object.keys($argument).forEach(t=>s.set(e,t,$argument[t])),r.Settings={...r.Settings,...e}}}let o=c.getItem(e);return o&&t.forEach(e=>{switch(typeof o?.[e]?.Settings){case"string":o[e].Settings=JSON.parse(o[e].Settings||"{}");case"object":r.Settings={...r.Settings,...o[e].Settings}}switch(typeof o?.[e]?.Caches){case"string":o[e].Caches=JSON.parse(o[e].Caches||"{}");case"object":r.Caches={...r.Caches,...o[e].Caches}}}),function e(t,a){for(let s in t){let r=t[s];t[s]="object"==typeof r&&null!==r?e(r,a):a(s,r)}return t}(r.Settings,(e,t)=>("true"===t||"false"===t?t=JSON.parse(t):"string"==typeof t&&(t=t.includes(",")?t.split(",").map(e=>n(e)):n(t)),t)),r}(e,t,r);return Array.isArray(o?.Types)||(o.Types=o.Types?[o.Types]:[]),a.info(`typeof Settings: ${typeof o}`,`Settings: ${JSON.stringify(o,null,2)}`),("object"!=typeof i?.Playlists||Array.isArray(i?.Playlists))&&(i.Playlists={}),i.Playlists.Master=new Map(JSON.parse(i?.Playlists?.Master||"[]")),i.Playlists.Subtitle=new Map(JSON.parse(i?.Playlists?.Subtitle||"[]")),"object"!=typeof i?.Subtitles&&(i.Subtitles=new Map(JSON.parse(i?.Subtitles||"[]"))),("object"!=typeof i?.Metadatas||Array.isArray(i?.Metadatas))&&(i.Metadatas={}),"object"!=typeof i?.Metadatas?.Tracks&&(i.Metadatas.Tracks=new Map(JSON.parse(i?.Metadatas?.Tracks||"[]"))),a.log("✅ Set Environment Variables"),{Settings:o,Caches:i,Configs:l}}("DualSubs","Spotify",l);a.logLevel=e.LogLevel;let y=u.searchParams.get("subtype")??e.Type,h=[u.searchParams.get("lang")?.toUpperCase?.()??e.Languages[0],(u.searchParams.get("tlang")??r?.tlang)?.toUpperCase?.()??e.Languages[1]];a.info(`Type: ${y}`,`Languages: ${h}`);let f={};switch($request.method){case"POST":case"PUT":case"PATCH":case"DELETE":switch(p){case void 0:case"application/x-www-form-urlencoded":case"text/plain":default:case"application/x-mpegURL":case"application/x-mpegurl":case"application/vnd.apple.mpegurl":case"audio/mpegurl":case"text/xml":case"text/html":case"text/plist":case"application/xml":case"application/plist":case"application/x-plist":case"text/vtt":case"application/vtt":case"text/json":case"application/json":break;case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":case"application/grpc":case"application/grpc+proto":case"application/octet-stream":{let e="Quantumult X"===t?new Uint8Array($request.bodyBytes??[]):$request.body??new Uint8Array;switch(p){case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":switch(u.pathname){case"/bootstrap/v1/bootstrap":case"/user-customization-service/v1/customize":delete $request.headers?.["If-None-Match"],delete $request.headers?.["if-none-match"]}}$request.body=e}}case"GET":if(u.pathname.startsWith("/color-lyrics/v2/track/")){let t=d?.[3];a.debug(`trackId: ${t}`);let s=JSON.parse(JSON.stringify($request));s.url=`https://api.spotify.com/v1/tracks?ids=${t}`,s?.headers?.Accept&&(s.headers.Accept="application/json"),s?.headers?.accept&&(s.headers.accept="application/json");let o=i($request),n=i(s);await Promise.allSettled([o,n]).then(t=>{switch(t[0].status){case"fulfilled":{let a=t[0].value;switch(a?.statusCode??a?.status){case 200:e.Types.includes("Translate")?u.searchParams.set("subtype","Translate"):e.Types.includes("External")&&u.searchParams.set("subtype","External");break;case 401:default:break;case 404:e.Types.includes("External")&&u.searchParams.set("subtype","External")}break}case"rejected":e.Types.includes("External")&&u.searchParams.set("subtype","External")}switch(t[1].status){case"fulfilled":f=JSON.parse(t[1].value.body),f?.tracks?.forEach?.(e=>{let t=e?.id,a={id:e?.id,track:e?.name,album:e?.album?.name,artist:e?.artists?.[0]?.name};r.Metadatas.Tracks.set(t,a)}),r.Metadatas.Tracks=function(e,t=100){return a.log("☑️ Set Cache",`cacheSize: ${t}`),e=(e=Array.from(e||[])).slice(-t),a.log("✅ Set Cache"),e}(r.Metadatas.Tracks,e.CacheSize),c.setItem("@DualSubs.Spotify.Caches.Metadatas.Tracks",r.Metadatas.Tracks);break;case"rejected":a.debug(`detectTrack.reason: ${JSON.stringify(t[1].reason)}`)}})}}$request.url=u.toString(),a.debug(`$request.url: ${$request.url}`)})().catch(e=>a.error(e)).finally(()=>{switch(typeof e){case"object":e.headers?.["Content-Encoding"]&&(e.headers["Content-Encoding"]="identity"),e.headers?.["content-encoding"]&&(e.headers["content-encoding"]="identity"),"Quantumult X"===t?(e.status||(e.status="HTTP/1.1 200 OK"),delete e.headers?.["Content-Length"],delete e.headers?.["content-length"],delete e.headers?.["Transfer-Encoding"],o(e)):o({response:e});break;case"undefined":o($request);break;default:a.error(`不合法的 $response 类型: ${typeof e}`)}})})();